<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>SeExpr: Using Variable Blocks</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SeExpr
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">SeExpr</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using Variable Blocks </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><!--
Copyright Disney Enterprises, Inc.  All rights reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License
 and the following modification to it: Section 6 Trademarks.
 deleted and replaced with:

 6. Trademarks. This License does not grant permission to use the
 trade names, trademarks, service marks, or product names of the
 Licensor and its affiliates, except as required for reproducing
 the content of the NOTICE file.

 You may obtain a copy of the License at
 http://www.apache.org/licenses/LICENSE-2.0
-->

<p>You can still define resolveVar() and resolveFunc() methods in your custom expression classes, but you now also have the option to use variable blocks instead. These are useful for re-using variables and managing thread evaluation.

Within your custom expression class, you would skip the usual resolveVar() and resolveFunc() implementations:

<pre>
class MyExpr:public SeExpr2::Expression {

// These are now optional:
//   resolveVar()
//   resolveFunc()
};
</pre>


<p> Here's how you might write an example function to run an expression that uses variable blocks. This example assumes you have a particle data struct p, with numParticles, numAttributes. A variable block contains variable names and types, but doesn't care what the values are.

<pre>
void f(const std::string& s, MyParticleData* p, int outputDim=3){

    // set up the bindings for each of the particle attributes
    SeExpr2::VarBlockCreator blockCreator;
    std::vector<int> variableHandles;
    std::vector<MyParticleAttr> attrs;
    for(int i=0; i<p->numAttrs(); i++) {
        MyParticleAttr attr;
        p->getAttrInfo(i,attr);
        attrs.push_back(attr);
        int handle = blockCreator.registerVariable(attr.name,
                                                   TypeVec(attr.dim));
        variableHandles.push_back(handle);
    }

    // set up binding for the output
    int outputVariableHandle=blockCreator.registerVariable("__output",
                                                           TypeVec(outputDim));

    // make an expression with the appropriate bindings
    MyExpr e(s);
    e.setDesiredType(TypeVec(outputDim));
    e.setVarBlockCreator(&blockCreator);
    if(!e.isValid()) throw std::runtime_error(e.parseError()):

    // create the variable block, set up pointers to data
    SeExpr2::VarBlock block = blockCreator.create();
    for(int i=0; i<p->numAttrs(); i++) {
        block.Pointer(variableHandles[i]) = p->data<double>(attrs[i]);
    }
    std::vector<double> outputData(p->numParticles()*outputDim);
    block.Pointer(outputVariableHandle)=outputData.data();

    // evaluate multiple expressions at once; inlines expressions
    e.evalMultiple(&block, outputVariableHandle, 0, p->numParticles());
}
</pre>

To parallelize evaluation per particle, a simple parallel_for can be used:
<pre>
    // evaluate multiple expressions at once, inlines expressions
    tbb::parallel_for(blocked_range(0,p->numParticles()),[](blocked_range r)) {
        VarBlock myBlock=block.clone(); //should be cheap
        e.evalMultiple(&myblock, outputVariableHandle, r.start, r.end);
    }
</pre>
 </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
